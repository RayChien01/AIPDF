<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Reader + Gemini AI (Pixel Perfect Edition)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* =========================================
           1. åŸºç¤ä½ˆå±€ (Layout)
           ========================================= */
        :root { --page-width-percent: 80%; --sidebar-width: 35vw; }
        
        body { background:#333; margin:0; padding:0; display:flex; flex-direction:row; height:100vh; font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif; color:white; overflow:hidden; }
        
        /* å·¦å´ä¸»ç•«é¢ */
        #main-area { flex:1; display:flex; flex-direction:column; height:100%; position:relative; transition:width .3s ease; overflow:hidden; }
        
        /* ä¸Šæ–¹æ§åˆ¶åˆ— */
        #controls { width:100%; height:60px; background:#1e1e1e; display:flex; align-items:center; justify-content:center; gap:15px; z-index:2000; box-shadow:0 4px 12px rgba(0,0,0,0.5); flex-shrink:0; border-bottom:1px solid #444; }
        
        /* PDF æ²å‹•å€ */
        #pdf-scroller { flex:1; overflow-y:auto; overflow-x:auto; display:flex; flex-direction:column; align-items:stretch; position:relative; width:100%; background:#333; scroll-behavior: auto; }
        
        /* æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†é€šç”¨æ¨£å¼ */
        .control-group { display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:8px; }
        button { background:#555; color:white; border:none; padding:5px 12px; border-radius:4px; cursor:pointer; font-size:14px; transition:.2s; white-space:nowrap; }
        button:hover { background:#777; }
        button:disabled { background:#444; color:#888; cursor:not-allowed; }
        button.active-toggle { background:#0e639c; }
        button.icon-btn { padding:5px 8px; background:transparent; font-size:16px; }
        button.icon-btn:hover { background:rgba(255,255,255,0.1); }
        input[type="number"] { width:50px; padding:5px; border-radius:4px; border:1px solid #555; background:#222; color:white; text-align:center; }
        #zoom-percent { min-width:40px; text-align:center; font-weight:bold; font-size:13px; color:#ddd; }

        /* =========================================
           2. å³å´ AI å´é‚Šæ¬„ (Sidebar)
           ========================================= */
        #ai-sidebar { width:var(--sidebar-width); background:#252526; border-left:1px solid #444; display:flex; flex-direction:column; height:100%; box-shadow:-4px 0 15px rgba(0,0,0,0.3); z-index:3000; transition:width .3s ease; overflow:hidden; }
        body.sidebar-hidden #ai-sidebar { width:0; border-left:none; }
        body.sidebar-hidden #ai-sidebar > * { display:none; }
        
        .sidebar-header { padding:10px 15px; background:#1e1e1e; border-bottom:1px solid #333; font-weight:bold; display:flex; justify-content:space-between; align-items:center; height:50px; box-sizing:border-box; }
        
        /* è¨­å®šé¢æ¿ */
        #settings-panel { display:block; background:#2d2d2d; border-bottom:1px solid #444; transition:max-height .3s ease-out, opacity .3s ease-out; overflow:hidden; max-height:500px; opacity:1; }
        #settings-panel.collapsed { max-height:0; opacity:0; border-bottom:none; padding:0; }
        .settings-section { padding:10px 15px; display:flex; flex-direction:column; gap:10px; border-bottom:1px solid #3a3a3a; }
        .settings-section:last-child { border-bottom:none; }
        #api-key-input, #model-select { width:100%; padding:8px; background:#333; border:1px solid #555; color:white; border-radius:4px; font-size:12px; box-sizing:border-box; }
        #model-select option { background:#333; color:white; padding:5px; }
        
        .context-mode-group { display:flex; gap:10px; font-size:12px; flex-wrap:wrap; }
        .context-mode-group label { cursor:pointer; display:flex; align-items:center; gap:4px; }
        .context-mode-group label.highlight { color: #4fc1ff; font-weight: bold; }

        #custom-range-wrapper { display:flex; align-items:center; gap:8px; margin-top:5px; padding:8px; background:#222; border-radius:4px; border:1px solid #444; transition: all 0.2s; }
        #custom-range-wrapper.hidden { display:none !important; }
        .range-input { width:60px !important; }
        .range-label { font-size:12px; color:#bbb; }

        /* èŠå¤©é¡¯ç¤ºå€ */
        #chat-container { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:15px; }
        .message { padding:10px; border-radius:8px; font-size:14px; line-height:1.4; max-width:90%; word-wrap:break-word; }
        .message.user { background:#0e639c; align-self:flex-end; color:white; }
        .message.ai { background:#3c3c3c; align-self:flex-start; color:#e0e0e0; }
        .message.system { background:transparent; color:#888; font-size:12px; text-align:center; align-self:center; }
        .message.error { background:rgba(255,0,0,0.2); color:#ffcccc; align-self:center; border:1px solid #ff4444; }
        
        .message.ai strong { color:#fff; font-weight:bold; }
        .message.ai code { background:#222; padding:2px 4px; border-radius:3px; font-family:monospace; }
        .message.ai pre { background:#222; padding:10px; border-radius:4px; overflow-x:auto; }
        .message.ai ul { padding-left:20px; }

        /* è¼¸å…¥å€ (åŒ…å«ä¸‰å€‹æŒ‰éˆ•) */
        .input-area { padding:15px; background:#1e1e1e; border-top:1px solid #333; display:flex; gap:8px; align-items:flex-start; }
        #user-input { flex:1; padding:10px; border-radius:4px; border:1px solid #444; background:#333; color:white; resize:none; height:45px; font-family:inherit; font-size:13px; }
        #user-input:focus { border-color:#0e639c; outline:none; }
        
        .action-btn-group { display:flex; flex-direction:column; gap:5px; }
        #send-btn { background:#0e639c; height:auto; padding:8px 10px; font-size:12px; flex:1; }
        #translate-btn { background:#2ea043; height:auto; padding:8px 10px; font-size:12px; flex:1; }
        #translate-btn:hover { background:#3fb950; }
        #grab-btn { background:#444; border:1px solid #555; color:#ccc; height:45px; width:35px; padding:0; display:flex; align-items:center; justify-content:center; font-size:18px; }
        #grab-btn:hover { background:#555; color:white; }

        /* =========================================
           3. PDF æª¢è¦–å™¨æ ¸å¿ƒæ¨£å¼ (Mozilla Firefox Source Code Match)
           ========================================= */
        #viewer-container { margin-top:20px; width:100%; display:flex; flex-direction:column; align-items:flex-start; gap:20px; padding:0 20px 100px; box-sizing:border-box; }
        
        .page-placeholder { 
            background:#fff; 
            box-shadow:0 4px 15px rgba(0,0,0,0.5); 
            width:var(--page-width-percent); 
            max-width:5000px; 
            min-width:300px; 
            position:relative; 
            margin:0 auto; 
        }

        .pdf-page-canvas { 
            display:block; 
            width:100%; 
            height:100%; 
            position:absolute; 
            top:0; 
            left:0; 
            z-index:1; 
        }
        
        /* ---------------------------------------------------------------------------------- */
        /* [æ ¸å¿ƒä¿®æ”¹] åŸºæ–¼ Firefox åŸå§‹ç¢¼çš„ç²¾æº–æ–‡å­—å±¤é…ç½® */
        /* ---------------------------------------------------------------------------------- */
        .textLayer { 
            position:absolute; 
            text-align: initial;
            top:0; 
            left:0; 
            right:0; 
            bottom:0; 
            overflow:hidden; 
            opacity:1; 
            line-height:1.0;
            text-size-adjust: none; 
            forced-color-adjust: none;
            transform-origin: 0 0;
            z-index:2; 
            
            /* [é‡è¦] é–å®šå®¹å™¨çš„æ»‘é¼ äº‹ä»¶ï¼Œåªå…è¨±é¸å–å…§éƒ¨çš„ span */
            /* é€™èƒ½è§£æ±ºã€Œé¸åˆ°è¡Œå°¾ç©ºç™½è™•ã€æˆ–ã€Œå³å´å‡ç©ºæ ¼ã€çš„å•é¡Œ */
            pointer-events: none; 

            /* é‡ç½®å­—è·ï¼Œé¿å…ç€è¦½å™¨è‡ªä½œè°æ˜ */
            letter-spacing: normal;
            word-spacing: normal;
        }

        .textLayer span { 
            color: transparent; 
            position: absolute; 
            white-space: pre; 
            cursor: text;
            transform-origin: 0% 0%;
            
            /* æ¢å¾© span çš„æ»‘é¼ äº’å‹• */
            pointer-events: auto;
        }

        /* è®“é¸å–ç¯„åœç¨å¾®æ˜é¡¯ä¸€é»ï¼Œä½¿ç”¨ Firefox é¢¨æ ¼ */
        .textLayer ::selection { 
            background: rgba(0, 0, 255, 0.2); /* ç´”æ·¨è—è‰²åŠé€æ˜ */
            color: transparent; 
        }
        
        .textLayer br { display: none; }
        /* ---------------------------------------------------------------------------------- */

        .loading-msg { display:flex; align-items:center; justify-content:center; height:100%; color:#888; font-size:14px; background:#444; position:relative; z-index:0; }
        .page-number-label { position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.5); color:white; padding:2px 8px; border-radius:4px; font-size:12px; pointer-events:none; z-index:10; }

        /* Math/LaTeX Styles */
        .katex { font-size: 1.1em !important; }
        .katex-display { overflow-x: auto; padding: 10px 0; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
</head>
<body>

<div id="main-area">
    <div id="controls">
        <input type="file" id="file-input" accept="application/pdf">
        <span id="page-info" style="font-size:14px; color:#ccc;">No file selected</span>
        <div class="control-group">
            <span>Zoom:</span>
            <button id="zoom-out">-</button>
            <span id="zoom-percent">80%</span>
            <button id="zoom-in">+</button>
        </div>
        <div class="control-group">
            <span>Go to:</span>
            <input type="number" id="jump-input" min="1" placeholder="#">
            <button id="jump-btn">Go</button>
        </div>
        <div class="control-group" style="margin-left:auto; margin-right:15px;">
            <button id="toggle-sidebar-btn" class="active-toggle">Sidebar</button>
        </div>
    </div>

    <div id="pdf-scroller">
        <div id="viewer-container">
            <div style="color:#888; margin-top:50px;">Please select a PDF file to begin.</div>
        </div>
    </div>
</div>

<div id="ai-sidebar">
    <div class="sidebar-header">
        <span>Gemini AI Assistant</span>
        <button id="toggle-settings-btn" class="icon-btn" title="Toggle Settings">âš™ï¸</button>
    </div>
    <div id="settings-panel">
        <div class="settings-section">
            <input type="password" id="api-key-input" placeholder="Paste Gemini API Key">
            <select id="model-select">
                <option value="gemini-2.5-flash" selected>Gemini 2.5 Flash (Standard/Fast)</option>
                <option value="gemini-2.0-flash">Gemini 2.0 Flash (Stable)</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Reasoning)</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (Legacy)</option>
            </select>
        </div>
        <div class="settings-section">
            <div style="font-size:12px; color:#bbb; margin-bottom:5px;">Context Strategy:</div>
            <div class="context-mode-group">
                <label class="highlight"><input type="radio" name="context-mode" value="dynamic" checked> Auto (Curr Â± 3)</label>
                <label><input type="radio" name="context-mode" value="custom"> Custom Range</label>
                <label><input type="radio" name="context-mode" value="none"> None</label>
                <label><input type="radio" name="context-mode" value="all"> Full PDF</label>
            </div>
            
            <div id="custom-range-wrapper" class="hidden">
                <span class="range-label">From:</span>
                <input type="number" id="custom-start" class="range-input" min="1" placeholder="Start">
                <span class="range-label">To:</span>
                <input type="number" id="custom-end" class="range-input" min="1" placeholder="End">
            </div>
            
            <div id="context-status" style="font-size:10px; color:#888; margin-top:5px;"></div>
        </div>
    </div>

    <div id="chat-container">
        <div class="message system">
            Welcome!<br>
            <b>Ask</b>: Questions about the PDF.<br>
            <b>Translate</b>: Translates selected text (or typed text) into Traditional Chinese.<br>
            <b>Paste (ğŸ“‹)</b>: Grabs selected text into input box.
        </div>
    </div>

    <div class="input-area">
        <button id="grab-btn" title="Paste Selection from PDF">ğŸ“‹</button>
        <textarea id="user-input" placeholder="Select text & click Translate, or type here..."></textarea>
        <div class="action-btn-group">
            <button id="send-btn">Ask</button>
            <button id="translate-btn">Translate</button>
        </div>
    </div>
</div>

<script>
let pdfDoc=null, pdfPageTexts=[], currentVisiblePage=1;
const MAX_CANVAS_DIMENSION=4096;
const MIN_ZOOM=30, MAX_ZOOM=400;
const container=document.getElementById('viewer-container');
const pdfScroller=document.getElementById('pdf-scroller');
const fileInput=document.getElementById('file-input');
const pageInfo=document.getElementById('page-info');
const jumpInput=document.getElementById('jump-input');
let currentWidthPercent=80;

const chatContainer=document.getElementById('chat-container');
const userInput=document.getElementById('user-input');
const sendBtn=document.getElementById('send-btn');
const translateBtn=document.getElementById('translate-btn');
const grabBtn=document.getElementById('grab-btn');
const apiKeyInput=document.getElementById('api-key-input');
const modelSelect=document.getElementById('model-select');

const customStartInput = document.getElementById('custom-start');
const customEndInput = document.getElementById('custom-end');
const customRangeWrapper = document.getElementById('custom-range-wrapper');
const contextModeInputs = document.querySelectorAll('input[name="context-mode"]');

const contextStatus=document.getElementById('context-status');
const zoomPercentLabel=document.getElementById('zoom-percent');
const toggleSidebarBtn=document.getElementById('toggle-sidebar-btn');
const toggleSettingsBtn=document.getElementById('toggle-settings-btn');
const settingsPanel=document.getElementById('settings-panel');

const pageStates={}; 
const visiblePages=new Set();
const renderQueue=[];
let isRendering=false;

pdfScroller.addEventListener('wheel',(e)=>{ if(e.shiftKey){ e.preventDefault(); pdfScroller.scrollLeft+=e.deltaY; }},{passive:false});

toggleSidebarBtn.addEventListener('click',()=>{ document.body.classList.toggle('sidebar-hidden'); const hidden=document.body.classList.contains('sidebar-hidden'); toggleSidebarBtn.classList.toggle('active-toggle',!hidden); toggleSidebarBtn.style.opacity=hidden?"0.7":"1"; });
toggleSettingsBtn.addEventListener('click',()=>settingsPanel.classList.toggle('collapsed'));

contextModeInputs.forEach(input => {
    input.addEventListener('change', () => {
        if(input.value === 'custom') {
            customRangeWrapper.classList.remove('hidden');
        } else {
            customRangeWrapper.classList.add('hidden');
        }
    });
});

// --- HELPER: GET CLEAN SELECTION ---
function getCleanSelection() {
    const selection = window.getSelection();
    if (selection && selection.toString().trim().length > 0) {
        // Remove line breaks from PDF copy/paste
        return selection.toString().trim().replace(/(\r\n|\n|\r)/gm, " ");
    }
    return "";
}

// --- RENDER MESSAGE ---
function addMessage(text,type){
    const div=document.createElement('div');
    div.className=`message ${type}`;
    
    if(type==='ai'){
        div.innerHTML = marked.parse(text);
        if(window.renderMathInElement) {
            renderMathInElement(div, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
        }
    } else {
        div.textContent = text;
    }
    
    chatContainer.appendChild(div);
    chatContainer.scrollTop=chatContainer.scrollHeight;
}

// --- CONTEXT LOGIC ---
function getSelectedContextText(){
    if(!pdfDoc) return null;
    const mode=document.querySelector('input[name="context-mode"]:checked').value;

    if(mode==='none') return {text:"",desc:"No file content included"};
    
    if(mode==='dynamic'){
        const start = Math.max(1, currentVisiblePage - 3);
        const end = Math.min(pdfDoc.numPages, currentVisiblePage + 3);
        let combined="";
        for(let i=start; i<=end; i++){
            if(pdfPageTexts[i]) combined += `[Page ${i}]\n${pdfPageTexts[i]}\n\n`;
        }
        return {text:combined, desc:`Auto: Pages ${start}-${end}`};
    }

    if(mode==='all'){
        let fullText=pdfPageTexts.slice(1).map((t,i)=>`[Page ${i+1}]\n${t}`).join('\n\n');
        if(fullText.length>5000000) fullText=fullText.slice(0,5000000)+"...(Truncated)";
        return {text:fullText,desc:`Full Text (${pdfDoc.numPages} pages)`};
    }
    
    if(mode==='custom'){
        let start = parseInt(customStartInput.value);
        let end = parseInt(customEndInput.value);
        
        if(isNaN(start) || isNaN(end)) return {text:"", desc:"Invalid page numbers"};
        if(start < 1) start = 1;
        if(end > pdfDoc.numPages) end = pdfDoc.numPages;
        if(start > end) { const temp=start; start=end; end=temp; } 

        let combined="";
        for(let i=start; i<=end; i++){
            if(pdfPageTexts[i]) combined += `[Page ${i}]\n${pdfPageTexts[i]}\n\n`;
        }
        return {text:combined,desc:`Custom: Pages ${start}-${end}`};
    }
    return {text:"",desc:"Unknown Mode"};
}

async function callGeminiAPI(promptText, displayDesc){
    const apiKey=apiKeyInput.value.trim(), modelName=modelSelect.value;
    if(!apiKey){ addMessage("Please enter your API Key first.","system"); return; }
    
    if(document.body.classList.contains('sidebar-hidden')){document.body.classList.remove('sidebar-hidden');toggleSidebarBtn.classList.add('active-toggle');toggleSidebarBtn.style.opacity="1";}
    
    addMessage(`Thinking... (${displayDesc})`,"system");
    const loadingMsg=chatContainer.lastElementChild;
    
    try{
        const resp=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:promptText}]}]})
        });
        const data=await resp.json();
        if(loadingMsg.parentNode) chatContainer.removeChild(loadingMsg);
        if(data.error){
            addMessage(`API Error: ${data.error.message}`,"error");
        } else if(data.candidates && data.candidates[0].content){
            addMessage(data.candidates[0].content.parts[0].text,"ai");
        } else addMessage("Empty response.","system");
    }catch(err){
        if(loadingMsg.parentNode) chatContainer.removeChild(loadingMsg);
        addMessage(`Network Error: ${err.message}`,"error");
    }
}

// --- BUTTON LISTENERS ---

// 1. ASK BUTTON (Standard Query)
sendBtn.addEventListener('click',()=>{
    const t=userInput.value.trim(); 
    if(!t) { alert("Please type a question."); return; }
    
    addMessage(t,"user"); 
    userInput.value=''; 
    
    const ctx = getSelectedContextText();
    const mathInstruction = "IMPORTANT: For any mathematical formulas, use LaTeX formatting (e.g., $E=mc^2$).";
    let promptText = "";
    let displayDesc = "";
    
    if(ctx && ctx.text){
        promptText=`You are a helpful study assistant. ${mathInstruction}\nThe user is reading page ${currentVisiblePage}. Context (${ctx.desc}):\n\n--- Start Context ---\n${ctx.text}\n--- End Context ---\n\nQuestion: ${t}`;
        displayDesc = ctx.desc;
    } else {
        promptText=`${mathInstruction}\n\nQuestion: ${t}`;
        displayDesc = "No Context";
    }
    
    callGeminiAPI(promptText, displayDesc);
});

// 2. TRANSLATE BUTTON (Smart: Selection OR Input)
translateBtn.addEventListener('click', () => {
    let text = userInput.value.trim();
    let source = "User Input";

    // Auto-Grab Logic: If input is empty, grab PDF selection
    if (!text) {
        text = getCleanSelection();
        if (text) {
            source = "Selected Text";
            addMessage(`[Target for Translation]\n"${text}"`, "system"); // Visual feedback
        }
    }

    if (!text) {
        alert("Please select text in the PDF or type something to translate.");
        return;
    }

    userInput.value = ''; // Clear input

    // Translation Prompt
    const ctx = getSelectedContextText();
    const contextStr = (ctx && ctx.text) ? `\n\nReference Context from PDF:\n${ctx.text}` : "";
    
    const translationPrompt = `
    Please act as a professional technical translator and English tutor.
    Task: Translate the user's text into Traditional Chinese (Taiwan).
    
    Constraints:
    1. Output format must be clean and structured (Markdown).
    2. Use the provided Reference Context (if any) to resolve technical terms.
    
    Required Output Format:
    **1. Sentence-by-Sentence Translation** (é€å¥ç¿»è­¯):
    > [Original English Sentence]
    > [Traditional Chinese Translation]
    (Repeat for all sentences)

    **2. Learning Notes** (é‡é»å–®å­—èˆ‡å¥å‹):
    * **[Word/Phrase]**: [Meaning in this context]. [Explanation of grammar or usage if complex].

    Text to Translate:
    """
    ${text}
    """
    ${contextStr}
    `;

    callGeminiAPI(translationPrompt, `Translation / ${source}`);
});

// 3. GRAB BUTTON (Paste Selection)
grabBtn.addEventListener('click', () => {
    const text = getCleanSelection();
    if (text) {
        userInput.value = text;
        userInput.focus();
    } else {
        alert("No text selected in the PDF.");
    }
});

// Enter Key: Defaults to "Ask" (Send)
userInput.addEventListener('keypress',(e)=>{ 
    if(e.key==='Enter'&&!e.shiftKey){ 
        e.preventDefault(); 
        sendBtn.click(); 
    }
});

// --- PDF PROCESSING ---
async function extractAllText(pdf){
    addMessage("Parsing PDF text in background...","system");
    const loadingMsg=chatContainer.lastElementChild;
    pdfPageTexts=new Array(pdf.numPages+1).fill("");
    try{
        const batch=10;
        for(let i=1;i<=pdf.numPages;i+=batch){
            const tasks=[];
            for(let j=0;j<batch&&(i+j)<=pdf.numPages;j++){
                tasks.push(pdf.getPage(i+j).then(page=>page.getTextContent().then(c=>{
                    pdfPageTexts[i+j]=c.items.map(it=>it.str).join(' ');
                })));
            }
            await Promise.all(tasks);
        }
        chatContainer.removeChild(loadingMsg);
        addMessage(`Parsing complete (${pdf.numPages} pages). Ready.`,"system");
    }catch(e){
        if(loadingMsg.parentNode) chatContainer.removeChild(loadingMsg);
        addMessage(`Parsing failed: ${e.message}`,"system");
    }
}

document.getElementById('zoom-in').addEventListener('click',()=>changeZoom(10));
document.getElementById('zoom-out').addEventListener('click',()=>changeZoom(-10));

function changeZoom(delta){
    const oldWidth = currentWidthPercent;
    const newWidth = Math.min(Math.max(oldWidth + delta, MIN_ZOOM), MAX_ZOOM);
    if(newWidth === oldWidth) return;
    const scroller = pdfScroller;
    const oldScrollHeight = scroller.scrollHeight;
    const oldScrollWidth = scroller.scrollWidth;
    if(oldScrollHeight === 0) {
        currentWidthPercent = newWidth;
        document.documentElement.style.setProperty('--page-width-percent', `${currentWidthPercent}%`);
        zoomPercentLabel.textContent = `${currentWidthPercent}%`;
        return;
    }
    const scrollTop = scroller.scrollTop;
    const scrollLeft = scroller.scrollLeft;
    const clientHeight = scroller.clientHeight;
    const clientWidth = scroller.clientWidth;
    const centerY = scrollTop + clientHeight / 2;
    const centerX = scrollLeft + clientWidth / 2;
    const ratioY = centerY / oldScrollHeight;
    const ratioX = centerX / oldScrollWidth;
    currentWidthPercent = newWidth;
    document.documentElement.style.setProperty('--page-width-percent', `${currentWidthPercent}%`);
    zoomPercentLabel.textContent = `${currentWidthPercent}%`;
    visiblePages.forEach(p => {
        const st = pageStates[p];
        if(st) st.renderedScale = null;
        enqueueRender(p);
    });
    const newScrollHeight = scroller.scrollHeight;
    const newScrollWidth = scroller.scrollWidth;
    scroller.scrollTop = (newScrollHeight * ratioY) - (clientHeight / 2);
    scroller.scrollLeft = (newScrollWidth * ratioX) - (clientWidth / 2);
}

fileInput.addEventListener('change',async(e)=>{
    const file=e.target.files[0]; if(!file) return;
    const fr=new FileReader();
    fr.onload=function(){ loadPDF(new Uint8Array(this.result)); };
    fr.readAsArrayBuffer(file);
});

async function loadPDF(data){
    container.innerHTML='<div style="color:white; margin-top:50px;">Loading PDF structure...</div>';
    try{
        pdfDoc=await pdfjsLib.getDocument(data).promise;
        pageInfo.textContent=`${pdfDoc.numPages} Pages`;
        jumpInput.max=pdfDoc.numPages;
        container.innerHTML='';
        extractAllText(pdfDoc);
        const firstPage=await pdfDoc.getPage(1);
        const viewport=firstPage.getViewport({scale:1});
        const aspect=viewport.height/viewport.width;
        for(let i=1;i<=pdfDoc.numPages;i++) createPagePlaceholder(i,aspect);
        startObserver();
    }catch(err){
        container.innerHTML=`<div style="color:red; margin-top:50px;">Error: ${err.message}</div>`;
    }
}

function createPagePlaceholder(pageNum,aspect){
    const div=document.createElement('div');
    div.className='page-placeholder';
    div.id=`page-container-${pageNum}`;
    div.dataset.pageNum=pageNum;
    div.style.aspectRatio=`${1/aspect}`;
    div.innerHTML=`<div class="loading-msg">Page ${pageNum}</div><div class="page-number-label">${pageNum}</div>`;
    container.appendChild(div);
    pageStates[pageNum]={renderedScale:null,isRendering:false};
}

let observer=null;
function startObserver(){
    if(observer) observer.disconnect();
    const opts={root:pdfScroller, rootMargin:'200px', threshold:[0,0.1,0.5]};
    observer=new IntersectionObserver(entries=>{
        entries.forEach(entry=>{
            const div=entry.target;
            const pageNum=parseInt(div.dataset.pageNum);
            if(entry.isIntersecting){
                visiblePages.add(pageNum);
                if(entry.intersectionRatio>0.3) currentVisiblePage=pageNum;
                enqueueRender(pageNum);
            } else {
                visiblePages.delete(pageNum);
            }
        });
    },opts);
    document.querySelectorAll('.page-placeholder').forEach(div=>observer.observe(div));
}

function enqueueRender(pageNum){
    const st=pageStates[pageNum]; if(!st) return;
    if(st.isRendering) return;
    if(st.renderedScale===currentWidthPercent) return;
    renderQueue.push(pageNum);
    processRenderQueue();
}

function processRenderQueue(){
    if(isRendering) return;
    const pageNum=renderQueue.shift();
    if(pageNum===undefined) return;
    isRendering=true;
    renderPage(pageNum).finally(()=>{isRendering=false; processRenderQueue();});
}

function getRenderScale(){
    const dpr=window.devicePixelRatio||1;
    const factor=Math.max(1, currentWidthPercent/100);
    return Math.min(3.0, Math.max(1.0, factor * dpr)); 
}

async function renderPage(pageNum){
    const divContainer=document.getElementById(`page-container-${pageNum}`);
    if(!divContainer) return;
    const state=pageStates[pageNum]; if(!state) return;
    if(state.renderedScale === currentWidthPercent) return;
    state.isRendering=true;
    try{
        const page=await pdfDoc.getPage(pageNum);
        const containerWidth=divContainer.clientWidth;
        const unscaled=page.getViewport({scale:1});
        const scale=containerWidth/unscaled.width;
        const viewport=page.getViewport({scale});
        const renderScale=getRenderScale();
        const pixelWidth=Math.floor(viewport.width * renderScale);
        const pixelHeight=Math.floor(viewport.height * renderScale);

        const frag=document.createDocumentFragment();
        const label=document.createElement('div');
        label.className='page-number-label'; label.textContent=pageNum;
        frag.appendChild(label);

        const canvas=document.createElement('canvas');
        canvas.className='pdf-page-canvas';
        canvas.width=pixelWidth; canvas.height=pixelHeight;
        canvas.style.width="100%"; canvas.style.height="100%";
        frag.appendChild(canvas);

        const renderContext={ canvasContext: canvas.getContext('2d'), transform:[renderScale,0,0,renderScale,0,0], viewport };
        const textContentPromise=page.getTextContent();
        await page.render(renderContext).promise;
        
        const textContent=await textContentPromise;
        const textLayerDiv=document.createElement('div');
        textLayerDiv.className='textLayer';
        
        // [ä¿®æ­£] è¨­å®š CSS è®Šæ•¸ --scale-factor ä»¥ç¢ºä¿ PDF.js æ­£ç¢ºè¨ˆç®—å­—é«”å¤§å°ï¼Œä¸¦ç§»é™¤ Math.floor é¿å…ç²¾åº¦èª¤å·®
        textLayerDiv.style.setProperty('--scale-factor', viewport.scale);
        textLayerDiv.style.width = `${viewport.width}px`;
        textLayerDiv.style.height = `${viewport.height}px`;
        
        frag.appendChild(textLayerDiv);
        pdfjsLib.renderTextLayer({ textContentSource:textContent, container:textLayerDiv, viewport, textDivs:[] });

        divContainer.replaceChildren(frag);
        state.renderedScale=currentWidthPercent;
    }catch(err){ console.error(err); }
    finally { state.isRendering=false; }
}

const jumpBtn=document.getElementById('jump-btn');
function jumpToPage(){
    const num=parseInt(jumpInput.value);
    if(pdfDoc && num>=1 && num<=pdfDoc.numPages){
        const target=document.getElementById(`page-container-${num}`);
        if(target){ target.scrollIntoView({behavior:'auto', block:'start'}); currentVisiblePage=num; }
    }
}
jumpBtn.addEventListener('click',jumpToPage);
jumpInput.addEventListener('keypress',(e)=>{ if(e.key==='Enter') jumpToPage(); });
</script>
</body>
</html>