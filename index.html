<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 閱讀器 + Gemini AI (v2.5 無限制版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <style>
        :root {
            --page-width-percent: 80%;
            --sidebar-width: 350px;
        }

        body {
            background-color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: row;
            height: 100vh;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: white;
            overflow: hidden;
        }

        /* --- 主區域 (閱讀器) --- */
        #main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            overflow-y: auto;
            position: relative;
        }

        /* --- 控制列 --- */
        #controls {
            position: sticky;
            top: 0;
            width: 100%;
            height: 60px;
            background: rgba(30, 30, 30, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            flex-shrink: 0;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 8px;
        }

        button {
            background: #555;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }
        button:hover { background: #777; }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }
        
        input[type="number"] {
            width: 50px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #222;
            color: white;
            text-align: center;
        }

        /* --- AI 側邊欄 --- */
        #ai-sidebar {
            width: var(--sidebar-width);
            background: #252526;
            border-left: 1px solid #444;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: -4px 0 15px rgba(0,0,0,0.3);
            z-index: 3000;
        }

        .sidebar-header {
            padding: 15px;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-key-section {
            padding: 10px;
            background: #2d2d2d;
            border-bottom: 1px solid #444;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #api-key-input {
            width: 95%;
            padding: 8px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            font-size: 12px;
        }

        #model-select {
            width: 100%;
            padding: 5px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        #chat-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            max-width: 90%;
            word-wrap: break-word;
        }

        .message.user {
            background: #0e639c;
            align-self: flex-end;
            color: white;
        }

        .message.ai {
            background: #3c3c3c;
            align-self: flex-start;
            color: #e0e0e0;
        }

        .message.system {
            background: transparent;
            color: #888;
            font-size: 12px;
            text-align: center;
            align-self: center;
        }

        .input-area {
            padding: 15px;
            background: #1e1e1e;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }

        #user-input {
            flex: 1;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #333;
            color: white;
            resize: none;
            height: 40px;
            font-family: inherit;
        }

        #send-btn {
            background: #0e639c;
            height: 40px;
            align-self: flex-start;
        }
        #send-btn:hover { background: #1177bb; }

        /* --- 閱讀器容器 --- */
        #viewer-container {
            margin-top: 20px; 
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding-bottom: 100px;
        }

        /* --- 頁面與文字層樣式 --- */
        .page-placeholder {
            background-color: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            width: var(--page-width-percent);
            max-width: 5000px; 
            min-width: 300px;
            position: relative;
        }

        .pdf-page-canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .textLayer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 1;
            line-height: 1.0;
            z-index: 2;
        }

        .textLayer span, .textLayer br {
            color: rgba(0, 0, 0, 0) !important;
            cursor: text;
            position: absolute;
            white-space: pre;
            transform-origin: 0% 0%;
        }

        .textLayer ::selection {
            background-color: rgba(0, 102, 255, 0.5) !important;
            color: rgba(0, 0, 0, 0) !important;
        }

        .textLayer span::selection {
            color: rgba(0, 0, 0, 0) !important;
            background-color: rgba(0, 102, 255, 0.5) !important;
        }

        .loading-msg {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            font-size: 14px;
            background: #444;
            position: relative;
            z-index: 0;
        }
        
        .page-number-label {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Markdown 樣式簡易支援 */
        .message.ai strong { color: #fff; font-weight: bold; }
        .message.ai code { background: #222; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        .message.ai ul, .message.ai ol { margin: 5px 0 5px 20px; padding: 0; }
        .message.ai pre { background: #222; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .message.ai blockquote { border-left: 3px solid #555; margin: 5px 0; padding-left: 10px; color: #aaa; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>

    <div id="main-area">
        <div id="controls">
            <input type="file" id="file-input" accept="application/pdf">
            <span id="page-info" style="font-size: 14px; color: #ccc;">未選擇</span>

            <div class="control-group">
                <span>縮放:</span>
                <button id="zoom-out">-</button>
                <button id="zoom-in">+</button>
            </div>

            <div class="control-group">
                <span>跳至:</span>
                <input type="number" id="jump-input" min="1" placeholder="#">
                <button id="jump-btn">Go</button>
            </div>
        </div>

        <div id="viewer-container">
            <div style="color: #888; margin-top: 50px;">請選擇檔案以開始閱讀</div>
        </div>
    </div>

    <div id="ai-sidebar">
        <div class="sidebar-header">
            <span>Gemini AI 助理</span>
        </div>
        
        <div class="api-key-section">
            <input type="password" id="api-key-input" placeholder="貼上您的 Gemini API Key">
            <select id="model-select" title="選擇 AI 模型版本">
                <option value="gemini-2.5-flash" selected>Gemini 2.5 Flash (預設/最新)</option>
                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            </select>
            <div style="font-size: 10px; color: #888;">Key 僅存於本地記憶體。</div>
        </div>

        <div id="chat-container">
            <div class="message system">歡迎！<br>已預設使用 <b>Gemini 2.5 Flash</b>。<br>請載入 PDF 並填入 API Key。</div>
        </div>

        <div class="input-area">
            <textarea id="user-input" placeholder="詢問關於此文件的問題..."></textarea>
            <button id="send-btn">發送</button>
        </div>
    </div>

    <script>
        // === 全域變數 ===
        let pdfDoc = null;
        let pdfFullText = ""; 
        
        const MAX_CANVAS_DIMENSION = 4096;
        const RENDER_SCALE_MULTIPLIER = 2.0; 

        const container = document.getElementById('viewer-container');
        const fileInput = document.getElementById('file-input');
        const pageInfo = document.getElementById('page-info');
        const jumpInput = document.getElementById('jump-input');
        const mainArea = document.getElementById('main-area'); 
        
        let currentWidthPercent = 80;

        // --- AI 聊天相關邏輯 ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const apiKeyInput = document.getElementById('api-key-input');
        const modelSelect = document.getElementById('model-select');

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            if (type === 'ai') {
                div.innerHTML = marked.parse(text); 
            } else {
                div.textContent = text;
            }
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function callGeminiAPI(query) {
            const apiKey = apiKeyInput.value.trim();
            const modelName = modelSelect.value; 

            if (!apiKey) {
                addMessage("請先在上方輸入 Gemini API Key。", "system");
                return;
            }
            if (!pdfFullText) {
                addMessage("請先載入 PDF 文件。", "system");
                return;
            }

            addMessage(`思考中 (使用 ${modelName})...`, "system");
            const loadingMsg = chatContainer.lastElementChild;

            try {
                // --- 無字數限制模式 ---
                // 設定為 1000 萬字元，確保整本書都能送出
                const maxChars = 10000000; 
                let contextText = pdfFullText;
                
                if (contextText.length > maxChars) {
                    contextText = contextText.substring(0, maxChars) + "\n...(超過1000萬字，已截斷)...";
                }

                const promptText = `
                你是一個專業的 PDF 文件閱讀助理。以下是該文件的完整內容：
                
                --- 文件開始 ---
                ${contextText}
                --- 文件結束 ---
                
                請根據以上內容回答使用者的問題。
                使用者問題：${query}
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }]
                    })
                });

                const data = await response.json();
                
                if (loadingMsg.parentNode) chatContainer.removeChild(loadingMsg);

                if (data.error) {
                    let errorMsg = data.error.message;
                    // 若 2.5 不存在 (404) 或是額度問題 (429) 的提示
                    if (data.error.code === 404) {
                        errorMsg = `找不到模型 (${modelName})。請確認 API 是否支援此版本，或嘗試切換至 2.0/1.5。`;
                    } else if (data.error.code === 429) {
                        errorMsg = `額度限制 (429)：請稍後重試，或切換其他模型。`;
                    }
                    addMessage(`API 錯誤: ${errorMsg}`, "system");
                } else if (data.candidates && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    addMessage(aiText, "ai");
                } else {
                    addMessage("無法取得回應，請檢查 API Key 或網路狀態。", "system");
                }

            } catch (error) {
                if (loadingMsg.parentNode) chatContainer.removeChild(loadingMsg);
                addMessage(`請求失敗: ${error.message}`, "system");
            }
        }

        sendBtn.addEventListener('click', () => {
            const text = userInput.value.trim();
            if (text) {
                addMessage(text, "user");
                userInput.value = '';
                callGeminiAPI(text);
            }
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                sendBtn.click();
            }
        });

        // --- 提取 PDF 文字邏輯 ---
        async function extractAllText(pdf) {
            addMessage("正在讀取文件內容以供 AI 分析...", "system");
            const loadingMsg = chatContainer.lastElementChild;
            
            let fullText = "";
            try {
                const maxPages = pdf.numPages;
                for (let i = 1; i <= maxPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `[Page ${i}]\n${pageText}\n\n`;
                }
                pdfFullText = fullText;
                chatContainer.removeChild(loadingMsg);
                addMessage(`已讀取 ${maxPages} 頁內容。`, "system");
            } catch (e) {
                chatContainer.removeChild(loadingMsg);
                addMessage(`讀取文字失敗: ${e.message}`, "system");
            }
        }

        // --- 閱讀器邏輯 ---
        document.getElementById('zoom-in').addEventListener('click', () => changeZoom(10));
        document.getElementById('zoom-out').addEventListener('click', () => changeZoom(-10));

        function changeZoom(delta) {
            const newWidth = currentWidthPercent + delta;
            if (newWidth < 20 || newWidth > 500) return; 

            const viewportHeight = mainArea.clientHeight;
            const scrollY = mainArea.scrollTop;
            const centerY = scrollY + (viewportHeight / 2);
            
            let anchorPage = null;
            let relativeRatio = 0;

            const placeholders = document.querySelectorAll('.page-placeholder');
            for (let page of placeholders) {
                const pageTop = page.offsetTop;
                if (centerY >= pageTop && centerY <= (pageTop + page.offsetHeight)) {
                    anchorPage = page;
                    relativeRatio = (centerY - pageTop) / page.offsetHeight;
                    break;
                }
            }
            if (!anchorPage && placeholders.length > 0) anchorPage = placeholders[0];

            currentWidthPercent = newWidth;
            document.documentElement.style.setProperty('--page-width-percent', `${currentWidthPercent}%`);

            placeholders.forEach(div => unloadPage(div));

            if (anchorPage) {
                setTimeout(() => {
                    const newScrollY = anchorPage.offsetTop + (anchorPage.offsetHeight * relativeRatio) - (viewportHeight / 2);
                    mainArea.scrollTo(0, newScrollY);
                }, 0);
            }
            startObserver();
        }

        fileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const fileReader = new FileReader();
            fileReader.onload = function() { loadPDF(new Uint8Array(this.result)); };
            fileReader.readAsArrayBuffer(file);
        });

        async function loadPDF(data) {
            container.innerHTML = '<div style="color:white; margin-top:50px;">正在解析 PDF 結構...</div>';
            try {
                pdfDoc = await pdfjsLib.getDocument(data).promise;
                pageInfo.textContent = `共 ${pdfDoc.numPages} 頁`;
                jumpInput.max = pdfDoc.numPages;
                container.innerHTML = '';
                extractAllText(pdfDoc);
                const firstPage = await pdfDoc.getPage(1);
                const viewport = firstPage.getViewport({ scale: 1 });
                const aspectRatio = viewport.height / viewport.width;
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    createPagePlaceholder(i, aspectRatio);
                }
                startObserver();
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div style="color:red; margin-top:50px;">錯誤: ${error.message}</div>`;
            }
        }

        function createPagePlaceholder(pageNum, aspectRatio) {
            const div = document.createElement('div');
            div.className = 'page-placeholder';
            div.id = `page-container-${pageNum}`;
            div.dataset.pageNum = pageNum;
            div.style.aspectRatio = `${1 / aspectRatio}`; 
            div.innerHTML = `<div class="loading-msg">第 ${pageNum} 頁 (載入中...)</div><div class="page-number-label">${pageNum}</div>`;
            container.appendChild(div);
        }

        let observer = null;
        function startObserver() {
            if (observer) observer.disconnect();
            const options = { root: mainArea, rootMargin: '600px', threshold: 0 };
            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const div = entry.target;
                    const pageNum = parseInt(div.dataset.pageNum);
                    if (entry.isIntersecting) {
                        renderPage(div, pageNum);
                    } else {
                        unloadPage(div);
                    }
                });
            }, options);
            document.querySelectorAll('.page-placeholder').forEach(div => observer.observe(div));
        }

        async function renderPage(divContainer, pageNum) {
            if (divContainer.querySelector('.textLayer')) return;
            try {
                const page = await pdfDoc.getPage(pageNum);
                const containerWidth = divContainer.clientWidth;
                const unscaledViewport = page.getViewport({ scale: 1 });
                const scale = containerWidth / unscaledViewport.width;
                const viewport = page.getViewport({ scale: scale });

                divContainer.innerHTML = '';
                const pageNumLabel = document.createElement('div');
                pageNumLabel.className = 'page-number-label';
                pageNumLabel.textContent = pageNum;
                divContainer.appendChild(pageNumLabel);

                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                
                const outputScale = window.devicePixelRatio || 1; 
                let transformScale = outputScale * RENDER_SCALE_MULTIPLIER;

                let pixelWidth = Math.floor(viewport.width * transformScale);
                let pixelHeight = Math.floor(viewport.height * transformScale);

                if (pixelWidth > MAX_CANVAS_DIMENSION || pixelHeight > MAX_CANVAS_DIMENSION) {
                    const maxAllowed = Math.min(MAX_CANVAS_DIMENSION / pixelWidth, MAX_CANVAS_DIMENSION / pixelHeight);
                    transformScale *= maxAllowed;
                    pixelWidth = Math.floor(viewport.width * transformScale);
                    pixelHeight = Math.floor(viewport.height * transformScale);
                }
                
                canvas.width = pixelWidth;
                canvas.height = pixelHeight;
                canvas.style.width = Math.floor(viewport.width) + "px";
                canvas.style.height = Math.floor(viewport.height) + "px";

                divContainer.appendChild(canvas);

                const renderContext = {
                    canvasContext: canvas.getContext('2d'),
                    transform: [transformScale, 0, 0, transformScale, 0, 0],
                    viewport: viewport
                };
                
                const textContent = await page.getTextContent();
                const textLayerDiv = document.createElement('div');
                textLayerDiv.className = 'textLayer';
                textLayerDiv.style.width = Math.floor(viewport.width) + "px";
                textLayerDiv.style.height = Math.floor(viewport.height) + "px";
                divContainer.appendChild(textLayerDiv);

                const renderTask = page.render(renderContext);
                const textTask = pdfjsLib.renderTextLayer({
                    textContentSource: textContent,
                    container: textLayerDiv,
                    viewport: viewport,
                    textDivs: []
                });
                await Promise.all([renderTask.promise, textTask.promise]);
            } catch (err) {
                console.error(`Error rendering page ${pageNum}:`, err);
                divContainer.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:red;">渲染失敗</div>`;
            }
        }

        function unloadPage(divContainer) {
            if (divContainer.querySelector('.loading-msg')) return;
            const pageNum = divContainer.dataset.pageNum;
            divContainer.innerHTML = `<div class="loading-msg">第 ${pageNum} 頁</div><div class="page-number-label">${pageNum}</div>`;
        }

        const jumpBtn = document.getElementById('jump-btn');
        function jumpToPage() {
            const num = parseInt(jumpInput.value);
            if (num >= 1 && num <= pdfDoc.numPages) {
                const target = document.getElementById(`page-container-${num}`);
                if (target) target.scrollIntoView({ behavior: 'auto', block: 'start' });
            }
        }
        jumpBtn.addEventListener('click', jumpToPage);
        jumpInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') jumpToPage(); });
    </script>
</body>
</html>